!function(a,b){"object"==typeof exports?module.exports=b(require("d3","underscore")):"function"==typeof define&&define.amd?define(["d3","underscore"],b):b(a.d3,a._)}(this,function(a,b){"use strict";return function(a,b){function c(a){return!b.isNull(a)&&!b.isUndefined(a)}function d(a,b){function d(b){return b[f]?b[f][a]:null}function e(b,c){b[f]=b[f]||{},b[f][a]=c}var f="__properties";b=b||{};var g=function(a){var f=d(this);if(!arguments.length)return a=c(f)?f:g.defaultValue,a&&"function"==typeof a&&"function"!=b.type&&(a=a.call(this)),"function"==typeof b.get?b.get.call(this,a):a;var h=f;if(e(this,a),"function"==typeof b.set){var i=b.set.call(this,a,h);i&&i.override&&e(this,i.override),i&&i.after&&i.after.call(this,d(this))}return this};return g.isProperty=!0,g.setFromOptions=c(b.setFromOptions)?b.setFromOptions:!0,g.defaultValue=b.defaultValue,g}function e(a){var b=a&&a.length&&a[0]&&a[0].length&&a[0][0];return{width:parseFloat(a&&a.attr("width")||b&&b.clientWidth||0),height:parseFloat(a&&a.attr("height")||b&&b.clientHeight||0)}}function f(a,c){return b.isObject(a)&&(c=a.y,a=a.x),"translate("+a+", "+c+")"}function g(c){if(c=c||{},b.isFunction(c))return c;var d=c.type&&a.scale[c.type]?a.scale[c.type]():a.scale.linear();return c.domain&&d.domain(c.domain),c.range&&d.range(c.range),d}function h(a,b){if(a&&!b&&(b=a,a={direction:"vertical",origin:"top"}),b&&b.attr){var c=0;b.attr("transform",function(){var b=this.getBBox(),d=0,e=0;return"horizontal"==a.direction?("left"!=a.origin&&"right"!=a.origin&&(a.origin="left"),d="left"==a.origin?c:c+b.width,c+=b.width):("top"!=a.origin&&"bottom"!=a.origin&&(a.origin="top"),e="top"==a.origin?c:c+b.height,c+=b.height),f(d,e)})}}function i(a){a=b.isArray(a)?a:b.toArray(arguments);var c=b.extend.apply(this,[{}].concat(a));return c.initialize&&(c.initialize=function(){var c=b.toArray(arguments);b.each(a,function(a){a.initialize&&a.initialize.apply(this,c)},this)}),c.transform&&(c.transform=function(c){return b.reduceRight(a,function(a,b){return b&&b.transform?b.transform.call(this,a):a},c,this)}),c}a.chart().mixin=function(c){var d=this;return c=b.isArray(c)?c:b.toArray(arguments),{extend:function(b,e,f){return e&&c.push(e),a.chart().extend.call(d,b,i(c),f)}}},a.chart.helpers={isDefined:c,property:d,dimensions:e,translate:f,createScaleFromOptions:g,stack:h,mixin:i}}(a,b),function(a,c){var d=c.property,e=c.isDefined,f=a.chart.extensions={};f.Series={seriesKey:function(a){return a.key},seriesValues:function(a,c){return e(c)&&(a.seriesIndex=c),b.map(a.values,function(a){return e(c)&&(a.seriesIndex=c),a})},seriesClass:function(a,b){return"series index-"+b+(a["class"]?" "+a["class"]:"")},seriesIndex:function(a){return a.seriesIndex||0},seriesCount:function(){return this.data()?this.data().length:1},seriesLayer:function(b,c,d){if(d&&d.dataBind){var e=d.dataBind;d.dataBind=function(a){var b=this.chart(),c=this.selectAll("g").data(a,b.seriesKey.bind(b));return c.enter().append("g").attr("class",b.seriesClass.bind(b)),c.chart=function(){return b},e.call(c,b.seriesValues.bind(b))}}return a.chart().prototype.layer.call(this,b,c,d)}},f.XY={initialize:function(){this.on("change:data",this.setScales),this.options.xScale&&this.xScale(c.createScaleFromOptions(this.options.xScale)),this.options.yScale&&this.yScale(c.createScaleFromOptions(this.options.yScale))},x:function(a,b){return this._xScale()(this.xValue(a,b))},y:function(a,b){return this._yScale()(this.yValue(a,b))},x0:function(){return this._xScale()(0)},y0:function(){return this._yScale()(0)},xValue:function(a){return a.x},yValue:function(a){return a.y},keyValue:function(a){return a.key},setScales:function(){var a=this.xScale(),b=this.yScale();a||(a=this.setXScaleDomain(this.defaultXScale(),this.data()||[],this)),b||(b=this.setYScaleDomain(this.defaultYScale(),this.data()||[],this)),a=this.setXScaleRange(a,this.data()||[],this),b=this.setYScaleRange(b,this.data()||[],this),this._xScale(a)._yScale(b)},setXScaleDomain:function(a){return a.domain([this.xMin(),this.xMax()])},setYScaleDomain:function(a){return a.domain([this.yMin(),this.yMax()])},setXScaleRange:function(a,b,c){return a.range([0,c.width()])},setYScaleRange:function(a,b,c){return a.range([c.height(),0])},defaultXScale:function(){return a.scale.linear()},defaultYScale:function(){return a.scale.linear()},_xScale:d("_xScale",{type:"function"}),_yScale:d("_yScale",{type:"function"}),xScale:d("xScale",{type:"function",setFromOptions:!1}),yScale:d("yScale",{type:"function",setFromOptions:!1}),xMin:d("xMin",{get:function(c){var d=b.reduce(this.data(),function(b,c,d){var e=a.extent(this.seriesValues(c,d),this.xValue)[0];return b>e?e:b},1/0,this);return e(c)?c:0>d?d:0}}),xMax:d("xMax",{get:function(c){var d=b.reduce(this.data(),function(b,c,d){var e=a.extent(this.seriesValues(c,d),this.xValue)[1];return e>b?e:b},-1/0,this);return e(c)?c:d}}),yMin:d("yMin",{get:function(c){var d=b.reduce(this.data(),function(b,c,d){var e=a.extent(this.seriesValues(c,d),this.yValue)[0];return b>e?e:b},1/0,this);return e(c)?c:0>d?d:0}}),yMax:d("yMax",{get:function(c){var d=b.reduce(this.data(),function(b,c,d){var e=a.extent(this.seriesValues(c,d),this.yValue)[1];return e>b?e:b},-1/0,this);return e(c)?c:d}})},f.Values={isValues:!0,transform:function(a){return b.each(a,function(a){a.values=b.map(a.values,function(a){return a=b.isObject(a)?a:{y:a},{x:e(a.x)?a.x:a.key,y:a.y,key:a.key}},this)},this),a},x:function(a,b){return this._xScale()(this.xValue(a,b))+.5*this.layeredWidth()},defaultXScale:function(){return a.scale.ordinal()},setXScaleDomain:function(a,c){var d=b.reduce(c,function(a,c,d){var e=b.map(this.seriesValues(c,d),this.xValue.bind(this));return e.length>a.length?e:a},[],this);return a.domain(d)},setXScaleRange:function(a,b,c){return a.rangeBands([0,c.width()],this.itemPadding(),this.itemPadding()/2)},adjacentX:function(a,b){var c=this.adjacentWidth(a,b),d=this.x(a,b)-this.layeredWidth(a,b)/2+c/2;return d+c*this.seriesIndex(a,b)},adjacentWidth:function(a,b){return this.layeredWidth(a,b)/this.seriesCount()},layeredX:function(a,b){return this.x(a,b)},layeredWidth:function(){return this._xScale().rangeBand()},itemX:function(a,b){return this.displayAdjacent()?this.adjacentX(a,b):this.layeredX(a,b)},itemWidth:function(a,b){return this.displayAdjacent()?this.adjacentWidth(a,b):this.layeredWidth(a,b)},itemPadding:d("itemPadding",{defaultValue:.1}),displayAdjacent:d("displayAdjacent",{defaultValue:!1})}}(a,a.chart.helpers),function(a,b,c){var d=c.property;a.chart("Base",{initialize:function(a){this.options=a||{},b.each(this.options,function(a,b){this[b]&&this[b].isProperty&&this[b].setFromOptions&&this[b](a)},this)},transform:function(a){return this.data(a),a},width:function(){return c.dimensions(this.base).width},height:function(){return c.dimensions(this.base).height},data:d("data",{set:function(a){this.trigger("change:data",a)}})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c,d){c.property;a.chart("Base").mixin(d.Series).extend("Chart")}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c){var d=c.property;a.chart("Base").extend("Component",{chartOffset:d("chartOffset",{get:function(a){return a=a&&"object"==typeof a?a:{},a=b.defaults(a,{top:0,right:0,bottom:0,left:0})},set:function(a,c){return a=a&&"object"==typeof a?a:{},a=b.defaults(a,c,{top:0,right:0,bottom:0,left:0}),{override:a,after:function(){this.trigger("change:dimensions")}}}})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c){var d=c.property;a.chart("Base").extend("Container",{initialize:function(){this.charts=[],this.chartsById={},this.components=[],this.componentsById={},this.transform=function(a){return this.rawData(a),a},this.base.classed("chart",!0),this.chartBase(this.base.append("g").classed("chart-base",!0)),this.updateDimensions(),this.on("change:dimensions",function(){this.updateDimensions(),this.redraw()})},updateDimensions:function(){this.base.attr("width",this.width()).attr("height",this.height());var a=this.updateChartMargins();this.chartBase().attr("transform",c.translate(a.left,a.top)).attr("width",this.chartWidth()).attr("height",this.chartHeight())},redraw:function(){this.rawData()&&this.draw(this.rawData())},attachChart:function(a,b){b.id=a,this.attach(a,b),this.charts.push(b),this.chartsById[a]=b},attachComponent:function(a,b){b.id=a,this.attach(a,b),this.components.push(b),this.componentsById[a]=b,b.on("change:dimensions",function(){this.trigger("change:dimensions")})},updateChartMargins:function(){var a=this.chartMargins();return b.each(this.components,function(b){var c=b&&b.chartOffset&&b.chartOffset();c&&(a.top+=c.top||0,a.right+=c.right||0,a.bottom+=c.bottom||0,a.left+=c.left||0)},this),this._chartMargins(a),a},rawData:d("rawData"),chartBase:d("chartBase"),chartMargins:d("chartMargins",{get:function(a){return a=a&&"object"==typeof a?a:{},a=b.defaults(a,{top:0,right:0,bottom:0,left:0})},set:function(a,c){return a=a&&"object"==typeof a?a:{},a=b.defaults(a,c,{top:0,right:0,bottom:0,left:0}),{override:a,after:function(){this.trigger("change:dimensions")}}}}),_chartMargins:d("_chartMargins",{defaultValue:function(){return b.extend({},this.chartMargins())}}),chartWidth:function(){var a=this._chartMargins();return this.width()-a.left-a.right},chartHeight:function(){var a=this._chartMargins();return this.height()-a.top-a.bottom},width:d("width",{defaultValue:function(){return c.dimensions(this.base).width},set:function(){this.trigger("change:dimensions")}}),height:d("height",{defaultValue:function(){return c.dimensions(this.base).height},set:function(){this.trigger("change:dimensions")}})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c,d){var e=c.property;a.chart("Chart").mixin(d.XY).extend("Labels",{initialize:function(){this.seriesLayer("Labels",this.base.append("g").classed("labels",!0),{dataBind:function(a){var b=this.chart();return this.selectAll("text").data(a,b.keyValue.bind(b))},insert:function(){var a=this.chart();return this.append("text").classed("label",!0).attr("font-family",a.labelFontFamily()).attr("font-size",a.labelFontSize()).attr("alignment-baseline",a.labelAlignment.bind(a))},events:{enter:function(){var a=this.chart();this.attr("x",a.labelX.bind(a)).attr("y",a.y0.bind(a)).attr("text-anchor",a.labelAnchor.bind(a)).text(0)},"merge:transition":function(){var a=this.chart();this.attr("y",a.labelY.bind(a)).text(a.yValue.bind(a))}}})},labelX:function(a,b){return this.x(a,b)+this.calculatedLabelOffset(a,b).x},labelY:function(a,b){return this.y(a,b)+this.calculatedLabelOffset(a,b).y},calculatedLabelOffset:function(a,b){var c=this.labelOffset(),d={top:{x:0,y:-c},right:{x:c,y:0},bottom:{x:0,y:c},left:{x:-c,y:0}};return d[this.calculatedLabelPosition(a,b)]},labelAnchor:function(a,b){return"right"==this.calculatedLabelPosition(a,b)?"start":"left"==this.calculatedLabelPosition(a,b)?"end":"middle"},labelAlignment:function(a,b){var c={top:"after-edge",right:"middle",bottom:"before-edge",left:"middle"};return c[this.calculatedLabelPosition(a,b)]},calculatedLabelPosition:function(a,b){var c=this.labelPosition();return"top|bottom"==c?this.yValue(a,b)>=0?"top":"bottom":"right|left"==c?this.xValue(a,b)>=0?"right":"left":c},labelPosition:e("labelPosition",{defaultValue:"top"}),labelOffset:e("labelOffset",{defaultValue:14}),labelFontSize:e("labelFontSize",{defaultValue:"14px"}),labelFontFamily:e("labelFontFamily",{defaultValue:"sans-serif"})}),a.chart("Chart").mixin(a.chart("Labels").prototype,d.Values).extend("LabelValues",{labelX:function(a,b){return this.itemX(a,b)+this.calculatedLabelOffset(a,b).x}}),a.chart("Chart").extend("ChartWithLabels",{initialize:function(){this.showLabels()&&(this.labels=this.base.chart(this.isValues?"LabelValues":"Labels",this.options),this.labels.displayAdjacent&&this.displayAdjacent&&this.labels.displayAdjacent(this.displayAdjacent()),this.attach("Labels",this.labels))},showLabels:e("showLabels",{defaultValue:!0})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c,d){var e=c.property;a.chart("ChartWithLabels").mixin(d.XY).extend("Line",{initialize:function(){this.seriesLayer("Line",this.base.append("g").classed("line-chart",!0),{dataBind:function(){var a=this.chart();return a.lines(b.map(a.data(),function(b){return a.createLine(b)})),this.selectAll("path").data(function(b,c){return[a.data()[c]]},a.seriesKey.bind(a))},insert:function(){return this.append("path").classed("line",!0)},events:{"merge:transition":function(){var a=this.chart(),b=a.lines();this.attr("d",function(c,d){return b[a.seriesIndex(c,d)](a.seriesValues(c,d))})}}})},lines:e("lines",{defaultValue:[]}),createLine:function(b){var c=a.svg.line().x(this.x.bind(this)).y(this.y.bind(this)),d=b.interpolate||this.options.interpolate;return d&&c.interpolate(d),c}}),a.chart("ChartWithLabels").mixin(a.chart("Line").prototype,d.Values).extend("LineValues")}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c,d){var e=c.property;a.chart("ChartWithLabels").mixin(d.XY,d.Values).extend("Bars",{initialize:function(){this.seriesLayer("Bars",this.base.append("g").classed("bar-chart",!0),{dataBind:function(a){var b=this.chart();return this.selectAll("rect").data(a,b.keyValue.bind(b))},insert:function(){return this.append("rect").classed("bar",!0)},events:{enter:function(){var a=this.chart();this.attr("x",a.barX.bind(a)).attr("y",a.y0.bind(a)).attr("width",a.itemWidth.bind(a)).attr("height",0)},"merge:transition":function(){var a=this.chart();this.attr("y",a.barY.bind(a)).attr("height",a.barHeight.bind(a))}}})},barHeight:function(a,b){return Math.abs(this.y0(a,b)-this.y(a,b))},barX:function(a,b){return this.itemX(a,b)-this.itemWidth(a,b)/2},barY:function(a,b){var c=this.y(a,b),d=this.y0();return d>c?c:d},displayAdjacent:e("displayAdjacent",{defaultValue:!0})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c,d){var e=c.property;a.chart("Component").mixin(d.Series,d.XY).extend("Axis",{initialize:function(){this.axis=a.svg.axis(),this.layer("Axis",this.base.append("g").classed("axis",!0),{dataBind:function(){return this.selectAll("g").data([0])},insert:function(){var a=this.chart(),b=(a.axisPosition(),a.axisOrientation()),c="horizontal"==b?a._xScale():a._yScale();return a.axis.scale(c).orient(a.axisOrient()),this.append("g")},events:{merge:function(){var a=this.chart();this.attr("transform",a.axisTranlation.call(a)).call(a.axis)}}})},axisTranlation:function(a,b){var d={top:{x:0,y:0},right:{x:this.width(),y:0},bottom:{x:0,y:this.height()},left:{x:0,y:0},x0:{x:this.x0(a,b),y:0},y0:{x:0,y:this.y0(a,b)}};return c.translate(d[this.axisPosition()])},axisPosition:e("axisPosition",{defaultValue:"bottom",set:function(){var a=this.chartOffset(),b=this.axisOffset(),c=this.axisOrient();a[c]||(a[c]=b,this.chartOffset(a))}}),axisOffset:e("axisOffset",{defaultValue:function(){var a=this.axisOrientation();return"horizontal"==a?30:60}}),axisOrient:e("axisOrient",{defaultValue:function(){var a=this.axisPosition();return"x0"==a?a="left":"y0"==a&&(a="bottom"),a}}),axisOrientation:function(){var a={top:"horizontal",right:"vertical",bottom:"horizontal",left:"vertical",x0:"vertical",y0:"horizontal"};return a[this.axisPosition()]}}),a.chart("Component").mixin(a.chart("Axis").prototype,d.Values).extend("AxisValues")}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c){var d=c.property;a.chart("Component").mixin().extend("Legend",{initialize:function(){this.legend=this.base.append("g").classed("legend",!0),this.layer("Legend",this.legend,{dataBind:function(a){var b=this.chart();return this.selectAll("g").data(a,b.dataKey.bind(b))},insert:function(){var a=(this.chart(),this.append("g").attr("class",function(a,b){return"legend-group index-"+b}));return a.append("g").attr("class","legend-swatch"),a.append("text").attr("class","legend-label"),a},events:{merge:function(){var a=this.chart();this.select("g").each(a.createSwatches()),this.select("text").text(a.dataValue.bind(a)).attr("alignment-baseline","before-edge"),this.call(c.stack.bind(this,{origin:"top"}))}}})},dataKey:function(a){return a.key},dataValue:function(a){return a.value},createSwatches:function(){var b=this;return function(c,d){b.createSwatch(a.select(this),c,d)}},createSwatch:function(a){a.empty(),a.append("rect").attr("width",20).attr("height",20).attr("fill","red")},legendPosition:d("legendPosition",{defaultValue:"right",set:function(a){var b={top:0,right:0,bottom:0,left:0};b[a]=100,this.chartOffset(b)}})}),a.chart("Legend").extend("InsetLegend",{initialize:function(){this.positionLegend()},positionLegend:function(){if(this.legend){var a=this.legendPosition();this.legend.attr("transform",c.translate(a.x,a.y))}},legendPosition:d("legendPosition",{defaultValue:{x:10,y:10},set:function(a,c){return a=a&&b.isObject(a)?a:{},a=b.defaults(a,c||{},{x:0,y:0}),{override:a,after:function(){this.positionLegend()}}}})})}(a,b,a.chart.helpers,a.chart.extensions),function(a,b,c){c.property;a.chart("Container").extend("Configurable",{initialize:function(){if(b.each(this.options.charts,function(c,d){if(c=b.defaults(c||{},a.chart("Configurable").defaultChartOptions),a.chart(c.type)){var e=this.chartBase().chart(c.type,c),f="chart_"+d;this.attachChart(f,e)}},this),b.each(this.options.axes,function(c,d){if(c=b.defaults(c||{},a.chart("Configurable").defaultAxisOptions),a.chart(c.type)){var e=this.chartBase().chart(c.type,c),f="axis_"+d;this.attachComponent(f,e)}},this),this.options.legend){var c=b.defaults(this.options.legend,a.chart("Configurable").defaultLegendOptions);if(!a.chart(c.type))return;var d="InsetLegend"==c.type?this.chartBase():this.base,e=d.chart(c.type,c);this.attachComponent("legend",e)}},demux:function(a,b){var c=this.chartsById[a]||this.componentsById[a],d=c&&c.options&&c.options.dataKey||a;return b[d]}},{defaultChartOptions:{},defaultAxisOptions:{type:"Axis"},defaultLegendOptions:{type:"Legend",legendPosition:"right"}})}(a,b,a.chart.helpers,a.chart.extensions),a});