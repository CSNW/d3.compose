<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>d3.chart.multi - Debug</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="css/default.css">

  <link rel="stylesheet" type="text/css" href="../tmp/css/d3.chart.multi.base.css">
  <style>
    @media (min-width: 768px) {
      #chart {
        width: 600px;
        height: 400px;
      }  
    }
  </style>
</head>
<body>
  <svg id="chart"></svg>
  <div>
    Container: <span id="mouse-container"></span><br>
    Chart: <span id="mouse-chart"></span><br>
    Points: <span id="mouse-points"></span>
  </div>

  <script src="../bower_components/d3/d3.js"></script>
  <script src="../bower_components/d3.chart/d3.chart.js"></script>
  <script src="../bower_components/underscore/underscore.js"></script>
  <script src="../tmp/d3.chart.multi.js"></script>

  <script src="../bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript">
    d3.chart('Chart').extend('HoverLabels', d3.chart.helpers.mixin(d3.chart.extensions.Values, {
      initialize: function() {
        this.layer('HoverLabels', this.base.append('g').classed('chart-hover-points', true), {
          dataBind: function(data) {
            if (!_.isArray(data) || (data[0] && !data[0].coordinates))
              data = [];
            
            return this.selectAll('g').data(data);
          },
          insert: function() {
            var group = this.append('g');

            group.append('circle')
              .attr('stroke', 'black')
              .attr('fill', 'black')
              .attr('r', 3);

            group.append('text')
              .attr('text-anchor', 'middle')
              .attr('alignment-baseline', 'after-edge');

            return group;
          },
          events: {
            'merge': function() {
              var chart = this.chart();

              this.select('circle')
                .attr('cx', function(d, i) {
                  return d.coordinates.x;
                })
                .attr('cy', function(d, i) {
                  return d.coordinates.y;
                });

              this.select('text')
                .attr('x', function(d, i) {
                  return d.coordinates.x;
                })
                .attr('y', function(d, i) {
                  return d.coordinates.y - 10;
                })
                .text(function(d, i) {
                  return d.values.y;
                });
            },
            'exit': function() {
              this.remove();
            }
          },
        });
      }
    }));
  </script>
  <script type="text/javascript">
    var config = {
      type: 'Values',
      charts: {
        bars: {type: 'Bars', dataKey: 'decreasing'},
        line: {type: 'Line', dataKey: 'increasing'},
        points: {type: 'HoverLabels', dataKey: 'decreasing'}
      },
      axes: {
        
      }
    };
    var data = {
      increasing: [
        {
          key: 'inc-a',
          name: 'Increasing A',
          values: [
            {x: 0, y: 10},
            {x: 10, y: 20},
            {x: 20, y: 40},
            {x: 30, y: 70},
            {x: 40, y: 110},
            {x: 50, y: 160}
          ]
        },
        {
          key: 'inc-b',
          name: 'Increasing B',
          values: [
            {x: 0, y: 25},
            {x: 10, y: 30},
            {x: 20, y: 40},
            {x: 30, y: 55},
            {x: 40, y: 75},
            {x: 50, y: 100}
          ]
        }
      ],
      decreasing: [
        {
          key: 'dec-a',
          name: 'Decreasing A',
          values: [
            {x: 0, y: 160},
            {x: 10, y: 110},
            {x: 20, y: 70},
            {x: 30, y: 40},
            {x: 40, y: 20},
            {x: 50, y: 10}
          ]
        },
        {
          key: 'dec-b',
          name: 'Decreasing B',
          values: [
            {x: 0, y: 100},
            {x: 10, y: 75},
            {x: 20, y: 55},
            {x: 30, y: 40},
            {x: 40, y: 30},
            {x: 50, y: 25}
          ]
        }
      ]
    };

    var chart = d3.select('#chart')
      .chart('Multi', config)
      .chartMargins({top: 10, right: 10, bottom: 10, left: 10});

    chart.draw(data);

    var hoverLabels = chart.chartsById['points']

    // DEBUG
    chart.on('enter:mouse', function(coordinates) {
      logMouse('container', coordinates);
    });
    chart.on('move:mouse', function(coordinates) {
      logMouse('container', coordinates);
    });
    chart.on('leave:mouse', function() {
      logMouse('container');
    });
    chart.on('chart:enter:mouse', function(coordinates) {
      logMouse('chart', coordinates);
    });
    chart.on('chart:move:mouse', function(coordinates) {
      logMouse('chart', coordinates);
    });
    chart.on('chart:leave:mouse', function() {
      logMouse('chart');
    });
    chart.on('points:enter:mouse', function(points) {
      logMouse('points', points);
      hoverLabels.draw(points);
    });
    chart.on('points:move:mouse', function(points) {
      logMouse('points', points);
      hoverLabels.draw(points);
    });
    chart.on('points:leave:mouse', function() {
      logMouse('points');
      hoverLabels.draw([]);
    });

    function logMouse(type, coordinates) {
      var $selector = $('#mouse-' + type);

      if (!coordinates) {
        $selector.empty();
      }
      else {
        var msg = '';

        // points come in as Array
        if (_.isArray(coordinates)) {
          msg = _.compact(_.map(coordinates, logPoint)).join(', ');
        }
        else {
          msg = logCoordinates(coordinates);
        }

        $selector.text(msg);
      }

      function logPoint(point) {
        return point.series.name + ': {x = ' + point.values.x + ', y = ' + point.values.y + '}';
      }
      function logCoordinates(coordinates) {
        return 'x = ' + coordinates.x + ', y = ' + coordinates.y;
      }
    }
  </script>
</body>
</html>