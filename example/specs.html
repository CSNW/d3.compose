<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>d3.compose Example</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="css/default.css">

  <link rel="stylesheet" type="text/css" href="../_tmp/d3.compose.css">
  <style>
    .spec {
      margin-bottom: 16px;
    }
    .spec-run {
      margin-left: 4px;
    }
    .spec-chart {
      margin-top: 10px;
    }

    .resizable {
      /* Resizes automatically with container */
    }
  </style>

  <!-- Add jquery here for spec helper -->
  <script src="../bower_components/jquery/dist/jquery.js"></script>
  <script type="text/javascript">
    var specs = [];
    function spec(options) {
      // Grab elements from parent of currently executing script
      var $container = $('script').last().parent();
      options.elements = {
        container: $container[0],
        chart: $container.find('[data-chart]')[0],
        run: $container.find('[data-run]')[0],
        reset: $container.find('[data-reset]')[0]
      };

      specs.push(options);
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>d3.compose Specs</h1>

    <section class="spec">
      <span>Should re-layout correctly on redraw</span>
      <button class="spec-btn" data-run>Run</button>
      <button class="spec-btn" data-reset>Reset</button>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y, labels: true}
              },
              axes: {
                x: {title: 'X Axis', scale: scales.x},
                y: {title: 'Y Axis', scale: scales.y}
              },
              title: {text: 'Chart Title', margins: {top: 1.0, bottom: 1.0}},
              legend: {position: 'bottom'}
            });
          },
          data: 'spec-abc',
          run: function(options, chart) {
            chart.title('New chart title');
          }
        });
      </script>
    </section>

    <section class="spec">
      <span>Should layout bars adjacent and lines stacked (by default)</span>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {type: 'ordinal', data: data.values, key: 'x', centered: true},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              charts: {
                bars: {type: 'Bars', data: data.values, xScale: scales.x, yScale: scales.y},
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {type: 'Axis', scale: scales.x},
                y: {scale: scales.y}
              }
            });
          },
          data: 'spec-abc'
        });
      </script>
    </section>

    <section class="spec">
      <span>Should display axis above charts and below labels</span>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {domain: [-5, 5]}
            };

            return d3.compose.xy({
              charts: {
                line: {
                  type: 'Lines',
                  data: data.values,
                  xScale: scales.x,
                  yScale: scales.y,
                  style: {'stroke-width': '5px'},
                  labels: {style: {'font-weight': 'bold', 'font-size': '16px'}}
                },
              },
              axes: {
                x: {position: 'y0', xScale: scales.x, yScale: scales.y},
                y: {position: 'x0', xScale: scales.x, yScale: scales.y}
              }
            });
          },
          data: 'spec-overlap'
        });
      </script>
    </section>

    <section class="spec">
      <span>Lines should be smooth by default, but can be turned off</span>
      <button class="spec-btn" data-run>Run</button>
      <button class="spec-btn" data-reset>Reset</button>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {domain: [20, 60]}
            };

            return d3.compose.xy({
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {scale: scales.x},
                y: {scale: scales.y}
              },
              title: 'Smooth'
            });
          },
          data: 'spec-smooth',
          run: function(options, chart) {
            // TODO Set to not smooth...

            chart.title('Not Smooth');
          },
          reset: function(options) {

          }
        });
      </script>
    </section>

    <section class="spec">
      <span>d3 Axis extensions should be used by Axis</span>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              type: 'XY',
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {scale: scales.x, ticks: 5},
                y: {scale: scales.y}
              }
            });
          },
          data: 'spec-abc'
        });
      </script>
    </section>

    <section class="spec">
      <span>Chart should update when options change</span>
      <button class="spec-btn" data-run>Run</button>
      <button class="spec-btn" data-reset>Reset</button>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {data: data.values, key: 'y'}
            }

            return d3.compose.xy({
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {scale: scales.x, ticks: 5},
                y: {scale: scales.y}
              },
              title: 'Before'
            });
          },
          data: 'spec-abc',
          run: function(options, chart) {
            var previous = chart.options();

            chart.options(function(data) {
              var scales = {
                x: {domain: [0, 200]}
              };
              var updated = previous.call(chart, data);

              updated.title = 'After';
              updated.charts.line.xScale = scales.x;
              updated.axes.x = {position: 'bottom', scale: scales.x, ticks: 10};

              return updated;
            });
          }
        });
      </script>
    </section>

    <section class="spec">
      <span>Chart should update when data-bound options change</span>
      <button class="spec-btn" data-run>Run</button>
      <button class="spec-btn" data-reset>Reset</button>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {scale: scales.x, ticks: 5},
                y: {scale: scales.y}
              },
              title: {text: data.title}
            });
          },
          data: 'spec-data-bound',
          run: function(options, chart) {
            data[options.data].title = 'After (from data)';
            chart.draw(data[options.data]);
          },
          reset: function(options, chart) {
            data[options.data].title = 'Before (from data)';
          }
        });
      </script>
    </section>

    <section class="spec">
      <span>Should resize automatically (resize window to test)</span>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          resizable: true,
          chart: function(data) {
            var scales = {
              x: {type: 'ordinal', data: data.values, key: 'x', centered: true},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              charts: {
                bars: {type: 'Bars', data: data.values, xScale: scales.x, yScale: scales.y},
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {type: 'Axis', scale: scales.x},
                y: {scale: scales.y}
              }
            });
          },
          data: 'spec-abc'
        });
      </script>
    </section>

    <section class="spec">
      <span>Should have good default margins</span>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          resizable: true,
          margins: false,
          chart: function(data) {
            var scales = {
              x: {type: 'ordinal', data: data.values, key: 'x', centered: true},
              y: {data: data.values, key: 'y'}
            };

            return d3.compose.xy({
              charts: {
                bars: {type: 'Bars', data: data.values, xScale: scales.x, yScale: scales.y},
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              axes: {
                x: {type: 'Axis', scale: scales.x},
                y: {scale: scales.y}
              }
            });
          },
          data: 'spec-abc'
        });
      </script>
    </section>

    <section class="spec">
      <span>Should update on scale change</span>
      <button class="spec-btn" data-run>Run</button>
      <button class="spec-btn" data-reset>Reset</button>

      <div class="spec-chart" data-chart></div>
      <script type="text/javascript">
        spec({
          chart: function(data) {
            var scales = {
              x: {data: data.values, key: 'x'},
              y: {data: data.values, key: 'y'}
            };

            return {
              charts: {
                line: {type: 'Lines', data: data.values, xScale: scales.x, yScale: scales.y}
              },
              components: {
                'axis.x': {type: 'Axis', position: 'bottom', scale: scales.x, ticks: 5},
                'axis.y': {type: 'Axis', position: 'left', scale: scales.y}
              }
            };
          },
          data: 'spec-abc',
          run: function(options, chart) {
            data[options.data].values[1].values[0].y = 200;
            chart.draw(data[options.data]);
          },
          reset: function(options) {
            data[options.data].values[1].values[0].y = 100;
          }
        });
      </script>
    </section>
  </div>

  <script src="../bower_components/d3/d3.js"></script>
  <script src="../bower_components/d3.chart/d3.chart.js"></script>
  <script src="../bower_components/underscore/underscore.js"></script>

  <script src="../_tmp/d3.compose-all.js"></script>

  <script src="js/data.js"></script>
  <script type="text/javascript">
    // Startup examples
    var charts = [];
    _.each(specs, function(options) {
      options = _.defaults(options, {resizable: false, margins: true});

      var chart;
      function create() {
        chart = d3.select(options.elements.chart)
          .append('svg')
          .chart('Compose', options.chart);

        if (!options.resizable)
          chart.width(600).height(400);
        else
          $(options.elements.chart).addClass('resizable');

        if (options.margins)
          chart.margins({top: 10, right: 10, bottom: 10, left: 10});

        chart.draw(data[options.data]);
        charts.push(chart);
      }

      create();

      if (_.isFunction(options.run) || _.isFunction(options.reset)) {
        var $run = $(options.elements.run);
        var $reset = $(options.elements.reset);

        $reset.prop('disabled', true);
        if (_.isFunction(options.run)) {
          $run.on('click', function() {
            if ($run.attr('disabled'))
              return;

            options.run(options, chart);
            $run.attr('disabled', true);
            $reset.attr('disabled', false);
          });
        }

        $reset.on('click', function() {
          if ($reset.attr('disabled'))
            return;

          $(options.elements.chart).empty();
          if (_.isFunction(options.reset))
            options.reset(options);

          create();
          $run.attr('disabled', false);
          $reset.attr('disabled', true);
        });
      }
    });
  </script>
</body>
</html>
